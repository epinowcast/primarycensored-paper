% Template for PLoS
% Version 3.6 Aug 2022
%
% % % % % % % % % % % % % % % % % % % % % %
%
% -- IMPORTANT NOTE
%
% This template contains comments intended 
% to minimize problems and delays during our production 
% process. Please follow the template instructions
% whenever possible.
%
% % % % % % % % % % % % % % % % % % % % % % % 
%
% Once your paper is accepted for publication, 
% PLEASE REMOVE ALL TRACKED CHANGES in this file 
% and leave only the final text of your manuscript. 
% PLOS recommends the use of latexdiff to track changes during review, as this will help to maintain a clean tex file.
% Visit https://www.ctan.org/pkg/latexdiff?lang=en for info or contact us at latex@plos.org.
%
%
% There are no restrictions on package use within the LaTeX files except that no packages listed in the template may be deleted.
%
% Please do not include colors or graphics in the text.
%
% The manuscript LaTeX source should be contained within a single file (do not use \input, \externaldocument, or similar commands).
%
% % % % % % % % % % % % % % % % % % % % % % %
%
% -- FIGURES AND TABLES
%
% Please include tables/figure captions directly after the paragraph where they are first cited in the text.
%
% DO NOT INCLUDE GRAPHICS IN YOUR MANUSCRIPT
% - Figures should be uploaded separately from your manuscript file. 
% - Figures generated using LaTeX should be extracted and removed from the PDF before submission. 
% - Figures containing multiple panels/subfigures must be combined into one image file before submission.
% For figure citations, please use "Fig" instead of "Figure".
% See http://journals.plos.org/plosone/s/figures for PLOS figure guidelines.
%
% Tables should be cell-based and may not contain:
% - spacing/line breaks within cells to alter layout or alignment
% - do not nest tabular environments (no tabular environments within tabular environments)
% - no graphics or colored text (cell background color/shading OK)
% See http://journals.plos.org/plosone/s/tables for table guidelines.
%
% For tables that exceed the width of the text column, use the adjustwidth environment as illustrated in the example table in text below.
%
% % % % % % % % % % % % % % % % % % % % % % % %
%
% -- EQUATIONS, MATH SYMBOLS, SUBSCRIPTS, AND SUPERSCRIPTS
%
% IMPORTANT
% Below are a few tips to help format your equations and other special characters according to our specifications. For more tips to help reduce the possibility of formatting errors during conversion, please see our LaTeX guidelines at http://journals.plos.org/plosone/s/latex
%
% For inline equations, please be sure to include all portions of an equation in the math environment.  For example, x$^2$ is incorrect; this should be formatted as $x^2$ (or $\mathrm{x}^2$ if the romanized font is desired).
%
% Do not include text that is not math in the math environment. For example, CO2 should be written as CO\textsubscript{2} instead of CO$_2$.
%
% Please add line breaks to long display equations when possible in order to fit size of the column. 
%
% For inline equations, please do not include punctuation (commas, etc) within the math environment unless this is part of the equation.
%
% When adding superscript or subscripts outside of brackets/braces, please group using {}.  For example, change "[U(D,E,\gamma)]^2" to "{[U(D,E,\gamma)]}^2". 
%
% Do not use \cal for caligraphic font.  Instead, use \mathcal{}
%
% % % % % % % % % % % % % % % % % % % % % % % % 
%
% Please contact latex@plos.org with any questions.
%
% % % % % % % % % % % % % % % % % % % % % % % %

\documentclass[10pt,letterpaper]{article}
\usepackage[top=0.85in,left=2.75in,footskip=0.75in]{geometry}

% amsmath and amssymb packages, useful for mathematical formulas and symbols
\usepackage{amsmath,amssymb}

% Use adjustwidth environment to exceed column width (see example table in text)
\usepackage{changepage}

% textcomp package and marvosym package for additional characters
\usepackage{textcomp,marvosym}

% cite package, to clean up citations in the main text. Do not remove.
\usepackage{cite}

% Use nameref to cite supporting information files (see Supporting Information section for more info)
\usepackage{nameref,hyperref}

% line numbers
\usepackage[right]{lineno}

% ligatures disabled
\usepackage[nopatch=eqnum]{microtype}
\DisableLigatures[f]{encoding = *, family = * }

% color can be used to apply background shading to table cells only
\usepackage[table]{xcolor}

% array package and thick rules for tables
\usepackage{array}

% create "+" rule type for thick vertical lines
\newcolumntype{+}{!{\vrule width 2pt}}

% create \thickcline for thick horizontal lines of variable length
\newlength\savedwidth
\newcommand\thickcline[1]{%
  \noalign{\global\savedwidth\arrayrulewidth\global\arrayrulewidth 2pt}%
  \cline{#1}%
  \noalign{\vskip\arrayrulewidth}%
  \noalign{\global\arrayrulewidth\savedwidth}%
}

% \thickhline command for thick horizontal lines that span the table
\newcommand\thickhline{\noalign{\global\savedwidth\arrayrulewidth\global\arrayrulewidth 2pt}%
\hline
\noalign{\global\arrayrulewidth\savedwidth}}


% Remove comment for double spacing
%\usepackage{setspace} 
%\doublespacing

% Text layout
\raggedright
\setlength{\parindent}{0.5cm}
\textwidth 5.25in 
\textheight 8.75in

% Bold the 'Figure #' in the caption and separate it from the title/caption with a period
% Captions will be left justified
\usepackage[aboveskip=1pt,labelfont=bf,labelsep=period,justification=raggedright,singlelinecheck=off]{caption}
\renewcommand{\figurename}{Fig}

% Use the PLoS provided BiBTeX style
\bibliographystyle{plos2015}

% Remove brackets from numbering in List of References
\makeatletter
\renewcommand{\@biblabel}[1]{\quad#1.}
\makeatother



% Header and Footer with logo
\usepackage{lastpage,fancyhdr,graphicx}
\usepackage{epstopdf}
%\pagestyle{myheadings}
\pagestyle{fancy}
\fancyhf{}
%\setlength{\headheight}{27.023pt}
%\lhead{\includegraphics[width=2.0in]{PLOS-submission.eps}}
\rfoot{\thepage/\pageref{LastPage}}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrule}{\hrule height 2pt \vspace{2mm}}
\fancyheadoffset[L]{2.25in}
\fancyfootoffset[L]{2.25in}
\lfoot{\today}

%% Include all macros below

\newcommand{\lorem}{{\bf LOREM}}
\newcommand{\ipsum}{{\bf IPSUM}}

%% END MACROS SECTION


\begin{document}

\vspace*{0.2in}

% Title must be 250 characters or less.
\begin{flushleft}
{\Large
\textbf\newline{Modelling Delays with Primary Event Censored Distributions} % Please use "sentence case" for title and headings (capitalize only the first word in a title (or heading), the first word in a subtitle (or subheading), and any proper nouns).
}
\newline
% Insert author names, affiliations and corresponding author email (do not include titles, positions, or degrees).
\\
Samuel P. C. Brand\textsuperscript{1},
Name2 Surname\textsuperscript{2\Yinyang},
Name3 Surname\textsuperscript{2,3\textcurrency},
Name4 Surname\textsuperscript{2},
Name5 Surname\textsuperscript{2\ddag},
Name6 Surname\textsuperscript{2\ddag},
Sam Abbott\textsuperscript{2*},
\\
\bigskip
\textbf{1} \footnotesize Center for Forecasting and Outbreak Analytics, Centers for Disease Control and Prevention, United States of America
\\
\textbf{2} Affiliation Dept/Program/Center, Institution Name, City, State, Country
\\
\textbf{3} \footnotesize Centre for Mathematical Modelling of Infectious Diseases, London School of Hygiene \& Tropical Medicine, London, United Kingdom
\\
\bigskip

% Insert additional author notes using the symbols described below. Insert symbol callouts after author names as necessary.
% 
% Remove or comment out the author notes below if they aren't used.
%
% Primary Equal Contribution Note
\Yinyang These authors contributed equally to this work.

% Additional Equal Contribution Note
% Also use this double-dagger symbol for special authorship notes, such as senior authorship.
\ddag These authors also contributed equally to this work.

% Current address notes
\textcurrency Current Address: Dept/Program/Center, Institution Name, City, State, Country % change symbol to "\textcurrency a" if more than one current address note
% \textcurrency b Insert second current address 
% \textcurrency c Insert third current address

% Deceased author note
\dag Deceased

% Group/Consortium Author Note
\textpilcrow Membership list can be found in the Acknowledgments section.

% Use the asterisk to denote corresponding authorship and provide email address in note below.
* correspondingauthor@institute.edu

\end{flushleft}
% Please keep the abstract below 300 words
\section*{Abstract}
\textbf{TO DO}



% Please keep the Author Summary between 150 and 200 words
% Use first person. PLOS ONE authors please skip this step. 
% Author Summary not valid for PLOS ONE submissions.   
\section*{Author summary}
\textbf{TO DO}

\linenumbers

% Use "Eq" instead of "Equation" for equation citations.
\section*{Introduction}

<comment: I think somewhere in here we need to address that primary event censoring with secondary event censoring = double interval censoring and maybe cite coarsedatatools as a method to deal with it directly we can then say why this isn't the best approach?>

Time-to-event analysis, also known as survival analysis, concerns estimating the distribution of delay times between primary/initial and secondary/end events. Understanding the distribution of delay times plays a crucial role in various fields, including epidemiology, reliability analysis, and survival analysis. These distributions describe probabilistically the time between two events of interest, such as the incubation period of a disease or the time to failure of a component. Accurate estimation and calculation of these distributions is essential to understand the underlying processes and make informed decisions \cite{charniga2024best}. However, estimating these distributions can be challenging due to various factors, including censoring and truncation of the observed data \cite{Park2024.01.12.24301247}.

Beyond direct estimation, similar challenges arise when implementing discrete-time modelling approaches. Popular epidemiological modelling packages such as \textbf{EpiNow2} \cite{abbottepinow2} and \textbf{EpiEstim} \cite{Cori2013} require appropriately discretised continuous distributions—for example, when converting a continuously defined generation interval distribution to daily time steps. This discretisation process introduces additional complexities that must be handled carefully to maintain the statistical integrity of the underlying continuous distribution while adapting it to the discrete framework required by these models.

Many different statistical methods have been used to account for missing data, as described above, in time-to-event analysis \cite{leung1997censoring}. \textit{Ignore incomplete/censored observations}, in a situation where there is a mix of censored and uncensored data, the analyst discards the censored data \cite{little2019statistical}. \textit{Discretization/dichotomization of censored data}, the analyst ignores the underlying variance of the event times within their possible range of values and analysis time-to-events using either a discrete distribution or as a dichotomy between whether a secondary event is delayed by a certain amount or not. \textit{Fixed imputation of event times}, the analyst assumes that censored events occur at some fixed point in the possible range of values, for example, mid-point imputation in interval censoring. 

In epidemiological analysis, it is common to have no uncensored data; therefore, ignoring censored data is not a viable method. Discretization of censored data is possible, but this approach ignores variability of events within an interval and, therefore, will underestimate distribution variance. Fixed imputation for the primary event is a common approach in epidemiological analysis \textbf{many citations}, however, this approach is known to introduce bias into delay estimation \cite{law1992effects,Park2024.01.12.24301247}. In Park \textit{et al} \cite{Park2024.01.12.24301247} the imputation bias due to the use of a \textit{fixed} primary event imputation scheme was eliminated by allowing the primary event time for each data item to be an inferrable latent variable, a common approach to missing data imputation in Bayesian analysis of epidemiological data \cite{o1999bayesian}. However, the approach used by Park \textit{ et al.} introduces $N$ additional effective parameters into the Bayesian imputation of $N$ delay data items, which limits the ability of analysts to scale this method to large data sets.

We extend the method introduced by Park \textit{ et al.} by marginalising the latent primary event times within a Bayesian imputation of the delay distribution rather than treating them as effective parameters. This can be done in general using an efficient numerical quadrature scheme; although we demonstrate that analytical solutions for the marginalisation problem exist for many common parametric delay distributions. The marginalisation approach that we use introduces data exchangeability \cite{gelman_bayesian_2013} between data items with identical primary and secondary censoring intervals that are observed with the same right truncation. The combination of marginalisation and exchangeability makes our approach significantly more scalable than the approach introduced by Park \textit{ et al.} \cite{Park2024.01.12.24301247} while introducing no additional approximations into the underlying Bayesian inference for the underlying continuous delay distribution. The marginalisation approach introduced in this paper is made available to analysts by the open source R package \textbf{primarycensored} \cite{abbottprimarycensored}, which includes extensions to the stan probabilistic programming language and the fitdistrplus R package.


\section*{Materials and methods}


We focus on a subset of methods from time to event analysis that address data missingness problems commonly found in epidemiological datasets. We present the statistical problem as a double interval censoring problem, where both the primary event time and the secondary event times are interval censored \cite{Reich2009-aa}. We can recover single interval censoring problems by reducing one of the intervals to a point. In particular, all of the methods in `primarycensored` start by assuming no secondary event censoring and solving the primary censoring problem. This is the reason for the packages name despite the most common use case being when there is double censoring. A key assumption we make throughout is that the censoring window for events are known and independent of the event time within the censoring interval. This is known as non-informative censoring. <comment: this paragraph contains nearly everything I was missing from the introduction. I think its likely fine here and I can't see how to work it into the above naturally.>

\subsection*{Statistical model}
The target for inference is the distribution of the delay time between the primary and secondary events. We assume that the delay time is a random variable $T = S - P_{u}$ with distribution function $F_T(t) = Pr(T < t)$ and density function $f_T(t)$. In this treatment we assume that the delay time is shift-invariant, that is, the distribution of the delay time is the same regardless of the primary event time.

The (unconditional) primary event time is a random variable $P_{u}$ with distribution function $F_{P_{u}}(t)$ and density function $f_{P_{u}}(t)$. The secondary event time is a random variable $S$, but in this treatment we construct the secondary event time from the primary time and delay, therefore the marginal distribution of $S$ is not considered \cite{Park2024.01.12.24301247} .

The \textit{censoring window} for each event is the interval within which each event is known to have occurred, respectively, $P \in [t_P, t_P + w_P]$ and $S \in [t_S, t_S + w_S]$. The lengths of the censoring windows are $w_P$ and $w_S$ respectively. The precise event times within their windows are unobserved. Note that since the primary event time is known up to the censoring window, we are predominantly interested in the \textit{conditional} primary time $P = P_{u} | \{ P_{u} \in [t_P, t_P + w_P]\}$ which has density function:

\begin{eqnarray}
    \begin{aligned}
    f_{P}(p) &= {f_{P_{u}}(p) \over F_{P_{u}}(t_P + w_P) - F_{P_{u}}(t_P)}, \qquad &p \in [t_P, t_P + w_P],\\
    f_{P}(p) &= 0, \qquad &\text{otherwise}.
    \end{aligned}
\end{eqnarray}

<comment: I think everything below here and not in the next section would all fit more naturally as the first paragraph of the next section with some minor reworking.> 

In this paper, we measure the \textit{censored delay time} $T_c$ between the primary and secondary event windows from endpoint to endpoint: $T_c = t_S + w_S - (t_P + w_P)$. 

In our treatment below we focus on the survival function of the time after the end of the primary window to the secondary event time which we denote $S_{+}$. We then use this to derive the distribution of the censored delay time $T_c$. This is equivalent to, but differs in mathematical approach from other treatments of the censoring problems in epidemiology, such as Park et al \cite{Park2024.01.12.24301247}, see section [Connections to other approaches] for details.

\subsection{Censored delay time distribution}
In this section, we explain how to derive the distribution of the censored delay time $T_c$ from the distribution of the delay time $T$ and the conditional distribution of the primary event time $P$.

\subsubsection{Survival function of time from the end of the primary censoring window to the secondary event time}

When reasoning about the distribution of the censored delay time $T_c$, it is useful to consider the time from the end (right) point of the primary censoring interval to the secondary time as a random variable,

\begin{equation}
S_+ = S - (t_P + w_P) = T - ((t_P + w_P) - P) = T - C_P.
\end{equation}

Where $T$ is the delay distribution of interest and $C_P = (t_P + w_P) - P$ is the interval between the end (right) point of the primary censoring window and the primary event time; note that by definition $C_P$ is not observed but we can relate its distribution to the distribution of $P$: $F_{C_P}(p) = Pr(C_P < p) = Pr(P > t_P + w_P - p)$.

With non-informative censoring, it is possible to derive the upper distribution function of $S_+$ ($Q_{S_+}$), or \textit{survival function} of $S_+$, from the distribution of $T$ and the distribution of $C_P$.


\begin{equation}
\begin{split}
Q_{S_+}(t) &= Pr(S_+ > t) \\
&= Pr(T > C_P + t) \\
&= \mathbb{E}_{C_P} \Big[Q_T(t + C_P)\Big] \\
&= \int_0^{w_P} Q_T(t + p) f_{C_P}(p) dp.
\end{split}
\end{equation}


Using integration by parts gives:

\begin{equation}
\label{eq:survivalfunc}
Q_{S_+}(t) = Q_T(t + w_P) + \int_0^{w_P} f_T(t+p) F_{C_P}(p) dp.
\end{equation}

Where we have used that $Q^{'}_{T} = - f_T$, $Q_T$ is the survival function of the actual delay distribution of interest and $w_P$ is the length of the primary censoring window.

Equation \ref{eq:survivalfunc} is the key equation for our handling of primary delay distributions and is used to derive the distribution of the censored delay time $T_c$. It has the interpretation that the probability that the secondary event time is greater than $t$ after the end of the primary censoring window is the sum of two disjoint event probabilities:

1. The probability that the \textit{actual} delay time $T$ is greater than $t + w_P$.
2. The probability that the \textit{actual} delay time $T$ is between $t$ and $t + w_P$, and the primary event time $P$ occurred sufficiently close to the end of the primary censoring window that the secondary even occurred more than time $t$ after the end of the primary window.

\subsubsection{Probability of secondary event time within a secondary censoring window}

Having constructed the survival function of $S_+$ with equation \ref{eq:survivalfunc}, using numerical quadrature or analytically, we can calculate the probability mass of a secondary event time falling within a observed secondary censoring window of length $w_S$ that begins at time $n - w_S$ \textit{after} the primary censoring window. This is the probability that the censored delay time $T_c$ is $n$.

This gives the censored delay time probability by integrating over censored values

\begin{equation}
\label{eq:seccensorprob}
Pr(S_+ \in [n - w_S, n)) = Q_{S_+}(n-w_S) - Q_{S_+}(n).
\end{equation}


Note that the censored secondary event time can also occur within the primary censoring window. This happens with probability,
\begin{equation}
Q_{S_+}(-w_P) - Q_{S_+}(0) = 1 - Q_T(w_P) - \int_0^{w_P} f_T(p) F_{C_P}(p) dp = Pr(T< C).
\end{equation}

\subsection{Exponentially tilted primary event times}

<comment: This subsection isn't well connected at the moment. I think we just need this for the analytical solutions so perhaps let us move it to the SI >

In epidemiological analysis, it is common for primary events to occur at exponentially increasing or decreasing rates, for example, the incidence of new infections in an epidemic. In this case, the distribution of the primary event time within its censoring window is biased by the exponential growth or decay \cite{Park2024.01.12.24301247} (i.e. for exponential growth, the event time will more likely to be closer to the end of the censoring window and vice versa for decay). If we assume a reference uniform distribution within a primary censoring window $[k, k + w_P)$ then the distribution of the primary event time within the censoring window is the exponential tilted uniform distribution:

\begin{equation}
f_P(t) \propto \exp(r t) \mathbb{1}_{[k, k + w_P]}(t).
\end{equation}

In this case, the distribution function for $C_P$, that is the length of time left in the primary censor window \textit{after} the primary event time, is given by:

\begin{equation}
F_{C_P}(p; r) = {  1 - \exp(-r p) \over 1 - \exp(-r w_P)}, \qquad p \in [0, w_P]. (\#eq:fcp)
\end{equation}
Note that taking the limit $\lim_r \rightarrow 0$ in equation \@ref(eq:fcp) gives the uniform distribution function $F_{C_P}(p, 0) = p / w_P$.

In the following, it is convenient to use a (linear) difference operator defined as:

\begin{equation}
\Delta_{w}f(t) = f(t + w) - f(t).
\end{equation}

\subsection{Generative model and parameter inference}

<comment: I think we can drop all of this and instead just show how to get the PMF and CDF not in terms of the survival function (i.e swap in the 4 to 5) and do something similar for CDF then just wrap it up by writing down the likelihood of a secondary censored and truncated distirbution (cdf - cdf / cdf) and say we can sub in the primary censored version... >

THIS SUBSECTION DISCUSSES GENERATING FROM MODEL AND DOING INFERENCE 
\subsubsection{Generating random samples}
This function generates random samples from a, potentially truncated, primary event censored distribution. It adjusts the distribution by accounting for the primary event distribution, potential truncation at a maximum delay ($D$), and secondary event censoring.

The mathematical formulation for generating random samples from a primary event censored distribution is as follows:

1. Generate primary event times ($p$) from the specified primary event distribution ($f_p$) with parameters $\phi$, defined between 0 and the primary event window ($pwindow$):

\begin{equation}p \sim f_p(\phi), \quad p \in [0, pwindow]\end{equation}

2. Generate delays ($d$) from the specified delay distribution ($f_d$) with parameters $\theta$:

\begin{equation}d \sim f_d(\theta), \quad d \geq 0\end{equation}

3. Calculate the total delays ($t$) by adding the primary event times and the delays:

\begin{equation}t = p + d\end{equation}

4. Apply truncation (i.e. remove any delays that fall outside the observation window) to ensure that the delays are within the specified range $[0, D]$, where $D$ is the maximum observable delay:

\begin{equation}
t_{truncated} = \{t \mid 0 \leq t < D\}
\end{equation}

5. Round the truncated delays to the nearest secondary event window ($swindow$):

\begin{equation}t_{valid} = \lfloor \frac{t_{truncated}}{swindow} \rfloor \times swindow\end{equation}

\subsubsection{Primary event censored cumulative distribution function (CDF) for delays}

This function computes the primary event censored cumulative distribution function (CDF) for a given set of quantiles. It adjusts the CDF of delay distribution by accounting for the primary event distribution and potential truncation at a maximum delay ($D$). This is useful when we want to understand the probability that a delay will be less than or equal to a certain value, taking into account both the primary event distribution and any truncation in our data.

The primary event censored CDF, ($F_{\text{cens}}(q)$), is given by:

\begin{equation}
F_{\text{cens}}(q) = \int_{0}^{pwindow} F(q - p) \cdot f_{\text{primary}}(p) \, dp
\end{equation}

where $F$ is the CDF of the delay distribution, $f_{\text{primary}}$ is the PDF of the primary event times, and $pwindow$ is the primary event window.

If the maximum delay $D$ is finite, the CDF is normalized by dividing by $F_{\text{cens}}(D)$:

\begin{equation}
F_{\text{cens,norm}}(q) = \frac{F_{\text{cens}}(q)}{F_{\text{cens}}(D)}
\end{equation}

where $F_{\text{cens,norm}}(q)$ is the normalized CDF.

\subsubsection{Primary event censored probability mass function}
This function computes the primary event censored probability mass function (PMF) for a given set of quantiles using the CDF. On top of accounting for the primary event distribution and truncation, it also adjusts for secondary event censoring. This is particularly useful when working with discrete data or when we want to understand the probability of observing delays in specific time windows, such as daily reporting delays.

The primary event censored PMF, ($f_{\text{cens}}(d)$), is given by:

\begin{equation}
f_{\text{cens}}(d) = F_{\text{cens}}(d + \text{swindow}) - F_{\text{cens}}(d)
\end{equation}

where ($F_{\text{cens}}$) is the potentially right truncated primary event censored CDF and ($\text{swindow}$) is the secondary event window.

\subsubsection{Log-likelihood of delays}
THIS SECTION HAS THE LOGLIKE FUNCTION IN TERMS OF ABOVE AND MENTIONS INFERENCE

<comment: We need some sections here saying what we are going to do in the results i.e numerical validation etc etc etc ideally also a paragraph about implementation in the primaycensored package>

\section*{Results}

\subsection{Analytic results for uniform primary event time}

Applying a uniform primary event time distribution to equation 3
gives:

\begin{equation}
Q_{S_+}(t) = Q_T(t + w_P) + { 1 \over w_P} \int_0^{w_P} f_T(t+p) p~ dp.
\end{equation}

This is analytically solvable whenever the upper distribution function of $T$ is known and the mean of $T$ is analytically solvable from its integral definition.

In each case considered below it is easier to change the integration variable:

\begin{equation}
\begin{aligned}
Q_{S_+}(t) &= Q_T(t + w_P) + { 1 \over w_P} \int_t^{t+w_P} f_T(z) (z-t)~ dz \\
&= Q_T(t + w_P) + { 1 \over w_P} \Big[  \int_t^{t+w_P} f_T(z) z~ dz - t \Delta_{w_P}F_T(t) \Big].
\end{aligned}
\end{equation}

Note that for any distribution with an analytically available distribution function $F_T$ equation \@ref(eq:uniform) can be solved so long as the \textit{partial expectation}

\begin{equation}
\int_t^{t+w_P} f_T(z) z~ dz
\end{equation}

can be reduced to an analytic expression.

The insight here is that this will be possible for any distribution where the average of the distribution can be calculated analytically, which includes commonly used non-negative distributions such as the Gamma, Log-Normal and Weibull distributions.


% Place tables after the first paragraph in which they are cited.
\begin{table}[!ht]
\begin{adjustwidth}{-2.25in}{0in} % Comment out/remove adjustwidth environment if table fits in text column.
\centering
\caption{
{\bf Analytic results.}}
\begin{tabular}{|l+l|l|l|l|l|l|l|}
\hline
\multicolumn{4}{|l|}{\bf Heading1} & \multicolumn{4}{|l|}{\bf Heading2}\\ \thickhline
$cell1 row1$ & cell2 row 1 & cell3 row 1 & cell4 row 1 & cell5 row 1 & cell6 row 1 & cell7 row 1 & cell8 row 1\\ \hline
$cell1 row2$ & cell2 row 2 & cell3 row 2 & cell4 row 2 & cell5 row 2 & cell6 row 2 & cell7 row 2 & cell8 row 2\\ \hline
$cell1 row3$ & cell2 row 3 & cell3 row 3 & cell4 row 3 & cell5 row 3 & cell6 row 3 & cell7 row 3 & cell8 row 3\\ \hline
\end{tabular}
\begin{flushleft} These are analytic results etc etc
\end{flushleft}
\label{table1}
\end{adjustwidth}
\end{table}



<comment: I think that we want a section where we show the equivalence between simulated, analytically solved, and numerically solved distributions i.e like the getting started in primarycensored. I don't think we need to discuss how we get the simulated results aside from linking to the park paper as it is the same method and saying we use tooling from primarycensored (all methods of course).>

\subsection{Fitting delay distributions}

<comment: Here I think we just want something that looks like the fitting with stan vignette and just show recovery of the parameters. Potentially we want this for the fitdistrplusmethod as well but not sure it is needed. 
I think something like looking at Gamma, Lognormal, weibull, and something wiht no analytical solution yet and with each having the same kind of random, varying censoring as in that vignette.>
\begin{figure}[!h]
\caption{{\bf Fitted delay distributions.}
A: . B: Consectetur adipiscing elit.}
\label{fig1}
\end{figure}


\section*{Discussion}
Summary
Strengths and limitations 
Strengths and Limitations vs the literature
Future work
Conclusions


 
 
\nameref{S1_Appendix}.

\section*{Supporting information}

% Include only the SI item label in the paragraph heading. Use the \nameref{label} command to cite SI items in the text.
\paragraph*{S1 Fig.}
\label{S1_Fig}
{\bf Bold the title sentence.} Add descriptive text after the title of the item (optional).

\paragraph*{S2 Fig.}
\label{S2_Fig}
{\bf Lorem ipsum.} Maecenas convallis mauris sit amet sem ultrices gravida. Etiam eget sapien nibh. Sed ac ipsum eget enim egestas ullamcorper nec euismod ligula. Curabitur fringilla pulvinar lectus consectetur pellentesque.

\paragraph*{S1 File.}
\label{S1_File}
{\bf Lorem ipsum.}  Maecenas convallis mauris sit amet sem ultrices gravida. Etiam eget sapien nibh. Sed ac ipsum eget enim egestas ullamcorper nec euismod ligula. Curabitur fringilla pulvinar lectus consectetur pellentesque.

\paragraph*{S1 Video.}
\label{S1_Video}
{\bf Lorem ipsum.}  Maecenas convallis mauris sit amet sem ultrices gravida. Etiam eget sapien nibh. Sed ac ipsum eget enim egestas ullamcorper nec euismod ligula. Curabitur fringilla pulvinar lectus consectetur pellentesque.

\paragraph*{S1 Appendix.}
\label{S1_Appendix}
{\bf Lorem ipsum.} Maecenas convallis mauris sit amet sem ultrices gravida. Etiam eget sapien nibh. Sed ac ipsum eget enim egestas ullamcorper nec euismod ligula. Curabitur fringilla pulvinar lectus consectetur pellentesque.

\paragraph*{S1 Table.}
\label{S1_Table}
{\bf Lorem ipsum.} Maecenas convallis mauris sit amet sem ultrices gravida. Etiam eget sapien nibh. Sed ac ipsum eget enim egestas ullamcorper nec euismod ligula. Curabitur fringilla pulvinar lectus consectetur pellentesque.

\section*{Acknowledgments}
Cras egestas velit mauris, eu mollis turpis pellentesque sit amet. Interdum et malesuada fames ac ante ipsum primis in faucibus. Nam id pretium nisi. Sed ac quam id nisi malesuada congue. Sed interdum aliquet augue, at pellentesque quam rhoncus vitae.

\nolinenumbers

% Either type in your references using
% \begin{thebibliography}{}
% \bibitem{}
% Text
% \end{thebibliography}
%
% or
%
% Compile your BiBTeX database using our plos2015.bst
% style file and paste the contents of your .bbl file
% here. See http://journals.plos.org/plosone/s/latex for 
% step-by-step instructions.
% 
% \begin{thebibliography}{10}

% \bibitem{bib1}
% Conant GC, Wolfe KH.
% \newblock {{T}urning a hobby into a job: how duplicated genes find new
%   functions}.
% \newblock Nat Rev Genet. 2008 Dec;9(12):938--950.

% \bibitem{bib2}
% Ohno S.
% \newblock Evolution by gene duplication.
% \newblock London: George Alien \& Unwin Ltd. Berlin, Heidelberg and New York:
%   Springer-Verlag.; 1970.

% \bibitem{bib3}
% Magwire MM, Bayer F, Webster CL, Cao C, Jiggins FM.
% \newblock {{S}uccessive increases in the resistance of {D}rosophila to viral
%   infection through a transposon insertion followed by a {D}uplication}.
% \newblock PLoS Genet. 2011 Oct;7(10):e1002337.

% \end{thebibliography}

% THIS IS A CONVENIENCE PLACEHOLDER
% PLOS WILL WANT THE FORMAT ABOVE
\bibliography{pcensored}


\appendix \section{Other approaches} 


Using the notation from the methods overview given in Park et al \cite{Park2024.01.12.24301247}, we write the conditional probability of the secondary event time $S\in (S_L,S_R)$ given the primary event time $P \in (P_L,P_R)$ as:

\begin{equation}
\begin{aligned}
\mathrm{Pr}(S_L < S < S_R | P_L < P < P_R) &= \frac{\mathrm{Pr}(P_L < P < P_R, S_L < S < S_R)}{\mathrm{Pr}(P_L < P < P_R)} \\
   &= \frac{\int_{P_L}^{P_R} \int_{S_L}^{S_R} g_P(x) f_x(y-x) dy dx}{\int_{P_L}^{P_R} g_P(x) dx}\\
   &= \int_{P_L}^{P_R} \int_{S_L}^{S_R} g_P(x|P_L, P_R) f_x(y-x)dy dx
\end{aligned}
\end{equation}

In this paper, we assume that the forward distribution doesn't vary over time (such that $f_x = f$), then

\begin{equation}
\int_{P_L}^{P_R} \int_{S_L}^{S_R} g_P(x|P_L, P_R) f_x(y-x)dy dx = \int_{P_L}^{P_R} g_P(x|P_L, P_R) \big[F(S_R - x) - F(S_L - x)\big] dx
\end{equation}

Then, by using integration by parts, we get:

\begin{equation}
\begin{split}
\int_{P_L}^{P_R} g_P(x|P_L, P_R) \big[F(S_R - x) - F(S_L - x)\big] dx &=
F(S_R - P_R) - F(S_L - P_R)  \\ & - \int_{P_L}^{P_R} G_P(x|P_L, P_R) \big[f(S_L - x) - f(S_R - x)\big] dx
\end{split} (\#eq:park)
\end{equation}
Where we have used that $\partial_x F(S_R - x) = - f(S_R - x)$ and $\partial_x F(S_L - x) = - f(S_L - x)$.

We can now compare this to equation \@ref(eq:seccensorprob) by considering the following transformations:

- $P_L = -w_P$ and $P_R = 0$, this in this note we are treating the endpoint of the primary censoring window as the origin.
-  $S_L = n-w_S$ and $S_R = n$, that is that we are interested in the probability of the secondary event time falling within the secondary censoring window $[n, n+ w_S)$.

Then equation \@ref(eq:park) becomes:

\begin{equation}
\begin{aligned}
\mathrm{Pr}(S_L < S < S_R | P_L < P < P_R) &= F(n) - F(n-w_S) - \int_{-w_P}^{0} G_P(x|-w_P, 0) \big[f(n - w_S - x) - f(n - x)\big] dx
\end{aligned}
\end{equation}



Making the transformation $x = -p$, and rewriting in the notation of this note gives:
\begin{equation}
\begin{aligned}
&= F(n) - F(n-w_S) + \int_{w_P}^{0} G_P(-p|-w_P, 0) \big[f_T(n - w_S + p) - f_T(n +p)\big] dp \\
&= F(n) - F(n-w_S) + \int_{0}^{w_P} G_P(-p|-w_P, 0) \big[f_T(n + p) - f_T(n - w_S +p)\big] dp\\
&= F(n) - F(n-w_S) + \int_{0}^{w_P} (1 - F_{C_P}(p)) \big[f_T(n + p) - f_T(n - w_S +p)\big] dp\\
&= F(n + w_P) - F(n-w_S + w_P) + \int_{0}^{w_P} [f_T(n + p - w_S) - f_T(n + p)] F_{C_P}(p) dp\\
&= Q_T(n-w_S + w_P) - Q_T(n + w_P) + \int_{0}^{w_P} [f_T(n + p - w_S) - f_T(n + p)] F_{C_P}(p) dp \\
&= Q_{S_+}(n-w_S) - Q_{S_+}(n ).
\end{aligned}
\end{equation}
which is same as equation \@ref(eq:seccensorprob).

In this derivation, we have used that $G_P(x|-w_P, 0)$ is the distribution function from the time \textit{from} the start of the primary interval \textit{until} primary event time, and $F_{C_P}$ is the distribution function of the time \textit{until} the end of the primary event window \textit{from} the primary event time. Therefore, $G_P(-p|-w_P, 0) = Pr(P < -p | P \in (-w_P, 0)) = 1 - Pr(C_P \leq p) = 1 - F_{C_P}(p)$.

\section{Derivation of analytic results}

We now consider some specific delay distributions.

\subsection{Gamma distributed delay times}

The Gamma distribution has the density function:

\begin{equation}
f_T(z;k, \theta) = {1 \over \Gamma(k) \theta^k} z^{k-1} \exp(-z/\theta).
\end{equation}
Where $\Gamma$ is the Gamma function.

The Gamma distribution has the distribution function:

\begin{equation}
\begin{aligned}
F_T(z;k, \theta) &= {\gamma(k, z/\theta) \over \Gamma(k)}, \qquad z\geq 0,\\
F_T(z;k, \theta) &= 0, \qquad z < 0.
\end{aligned}
\end{equation}
Where $\gamma$ is the lower incomplete gamma function.

\subsection{Gamma partial expectation}

We know that the full expectation of the Gamma distribution is $\mathbb{E}[T] = k\theta$, which can be calculated as a standard integral. Doing the same integral for the partial expectation gives:

\begin{equation}
\begin{aligned}
\int_t^{t+w_P} f_T(z) z~ dz &= {1 \over \Gamma(k) \theta^k} \int_t^{t+w_P} \mathbb{1}(z \geq 0)  z  z^{k-1} \exp(-z/\theta)~dz \\
&=  {\Gamma(k+1) \theta^{k+1} \over \Gamma(k) \theta^k}  {1 \over \Gamma(k+1) \theta^{k+1}} \int_t^{t+w_P} \mathbb{1}(z \geq 0)  z^{k}  \exp(-z/\theta)~dz\\
&= k\theta \Delta_{w_P} F_T(t; k + 1, \theta).
\end{aligned} (\#eq:gammapartexp)
\end{equation}

\subsection{Survival function of $S_{+}$ for Gamma distribution}

By substituting equation \@ref(eq:gammapartexp) into equation \@ref(eq:disccensunifprim) we can solve for the survival function of $S_+$ in terms of analytically available functions:

\begin{equation}
Q_{S_+}(t; k, \theta) = Q_T(t + w_P; k, \theta) + { 1 \over w_P} \big[ k \theta \Delta_{w_P}F_T(t; k+1, \theta) - t \Delta_{w_P}F_T(t; k, \theta) \big].
(\#eq:survgammaunifprim)
\end{equation}

\subsection{Gamma discrete censored delay distribution}

By substituting \@ref(eq:survgammaunifprim) into \@ref(eq:disccensunifprim) we get the discrete censored delay distribution in terms of analytically available functions:
\begin{equation}
\begin{aligned}
f_n &= (n+1) F_T(n+1; k, \theta) + (n-1) F_T(n-1; k, \theta) - 2  n F_T(n; k, \theta) - k \theta \Delta_1^{(2)}F_T(n-1; k+1, \theta)\\
 &= (n+1) F_T(n+1; k, \theta) + (n-1) F_T(n-1; k, \theta) - 2  n F_T(n; k, \theta) \\
 &+ k \theta \Big( 2 F_T(n; k+1, \theta) - F_T(n-1; k+1, \theta) - F_T(n+1; k+1,\theta)  \Big) \qquad n = 0, 1, \dots.
\end{aligned}
\end{equation}

Which was also found by Cori \textit{et al} \cite{Cori2013}.

\subsection{Log-Normal distribution}

The Log-Normal distribution has the density function:

\begin{equation}
\begin{aligned}
f_T(z;\mu, \sigma) &= {1 \over z \sigma \sqrt{2\pi}} \exp\left( - {(\log(z) - \mu)^2 \over 2 \sigma^2} \right)\\
F_T(z;\mu, \sigma) &= 0, \qquad z < 0.
\end{aligned}
\end{equation}
And distribution function:

\begin{equation}
F_T(z;\mu, \sigma) = \Phi\left( {\log(z) - \mu \over \sigma} \right).
\end{equation}
Where $\Phi$ is the standard normal distribution function.

\subsection{Log-Normal partial expectation}

We know that the full expectation of the Log-Normal distribution is $\mathbb{E}[T] = e^{\mu + \frac{1}{2} \sigma^2}$, which can be calculated by integration with the integration substitution $y = (\ln z - \mu) / \sigma$. This has transformation Jacobian:

\begin{equation}
\frac{dz}{dy} = \sigma e^{\sigma y + \mu}.
\end{equation}

Doing the same integral for the partial expectation, and using the same integration substitution gives:

\begin{equation}
\begin{aligned}
\int_t^{t+w_P} z~ f_T(z; \mu, \sigma) dz &= {1 \over \sigma \sqrt{2\pi}} \int_t^{t+w_P}  \mathbb{1}(z \geq 0)  \exp\left( - {(\log(z) - \mu)^2 \over 2 \sigma^2} \right) dz \\
&= {1 \over \sqrt{2\pi}} \int_{(\ln t - \mu)/\sigma}^{(\ln(t+w_P) - \mu)/\sigma} e^{\sigma y + \mu} e^{-y^2/2} dy\\
&= {e^{\mu + \frac{1}{2} \sigma^2} \over \sqrt{2 \pi} } \int_{(\ln t - \mu)/\sigma}^{(\ln(t+w_P) - \mu)/\sigma} e^{-(y- \sigma)^2/2} dy \\
&= e^{\mu + \frac{1}{2} \sigma^2} \Big[\Phi\Big({\ln(t+w_P) - \mu \over \sigma} - \sigma\Big) - \Phi\Big({\ln(t) - \mu \over \sigma} - \sigma\Big) \Big]\\
&= e^{\mu + \frac{1}{2} \sigma^2} \Delta_{w_P}F_T(t; \mu + \sigma^2, \sigma).
\end{aligned} (\#eq:lognormpartexp)
\end{equation}

\subsection{Survival function of $S_{+}$ for Log-Normal distribution}

By substituting equation \@ref(eq:lognormpartexp) into equation \@ref(eq:disccensunifprim) we can solve for the survival function of $S_+$ in terms of analytically available functions:

\begin{equation}
Q_{S+}(t ;\mu, \sigma) = Q_T(t + w_P;\mu, \sigma) + { 1 \over w_P} \Big[ e^{\mu + \frac{1}{2} \sigma^2} \Delta_{w_P}F_T(t; \mu + \sigma^2, \sigma) - t\Delta_{w_P}F_T(t; \mu, \sigma) \Big]
\end{equation}

\subsection{Log-Normal discrete censored delay distribution}

By substituting \@ref(eq:lognormpartexp) into \@ref(eq:disccensunifprim) we get the discrete censored delay distribution in terms of analytically available functions:

\begin{equation}
\begin{aligned}
f_n &= (n+1) F_T(n+1; \mu, \sigma) + (n-1) F_T(n-1; \mu, \sigma) - 2 n F_T(n; \mu, \sigma) \\
 &- e^{\mu + \frac{1}{2} \sigma^2} \Delta_1^{(2)}F_T(n-1;\mu + \sigma^2, \sigma) \\
 &= (n+1) F_T(n+1; \mu, \sigma) + (n-1) F_T(n-1; \mu, \sigma) - 2 n F_T(n; \mu, \sigma) \\
  &+ e^{\mu + \frac{1}{2} \sigma^2} \Big( 2 F_T(n; \mu + \sigma^2, \sigma) - F_T(n+1; \mu + \sigma^2, \sigma) - F_T(n-1; \mu + \sigma^2, \sigma)  \Big)\qquad n = 0, 1, \dots.
\end{aligned}
\end{equation}

\subsection{Weibull distribution}

The Weibull distribution has the density function:

\begin{equation}
f_T(z;\lambda,k) =
\begin{cases}
\frac{k}{\lambda}\left(\frac{z}{\lambda}\right)^{k-1}e^{-(z/\lambda)^{k}}, & z\geq0 ,\\
0, & z<0,
\end{cases}
\end{equation}
And distribution function:

\begin{equation}
F_T(z;\lambda,k))=\begin{cases}1 - e^{-(z/\lambda)^k}, & z\geq0,\\ 0, & z<0.\end{cases}
\end{equation}
Where $\Phi$ is the standard normal distribution function.

\subsection{Weibull partial expectation}

We know that the full expectation of the Weibull distribution is $\mathbb{E}[T] = \lambda \Gamma(1 + 1/k)$, which can be calculated by integration using the integration substitution $y = (z / \lambda)^k$, which has transformation Jacobian:

\begin{equation}
\frac{dz}{dy} = \frac{\lambda}{k}y^{1/k - 1}.
\end{equation}

Doing the same integral for the partial expectation, and using the same integration substitution gives:

\begin{equation}
\begin{aligned}
\int_{t}^{t+w_P} z~ f_T(z; \lambda,k) dz  &= \int_t^{t+w_P} \mathbb{1}(z \geq 0) \frac{kz}{\lambda}\left(\frac{z}{\lambda}\right)^{k-1}e^{-(z/\lambda)^{k}} dz \\
&= k\int_t^{t+w_P} \mathbb{1}(z \geq 0) \left(\frac{z}{\lambda}\right)^{k}e^{-(z/\lambda)^{k}} dz  \\
&= \lambda k \int_{(t / \lambda)^k}^{((t + w_P) / \lambda)^k} \mathbb{1}(y \geq 0) y y^{1/k - 1} e^{-y} dy  \\
&= \lambda\int_{(t / \lambda)^k}^{((t + w_P) / \lambda)^k} \mathbb{1}(y \geq 0)  y^{1/k} e^{-y} dy\\
&= \lambda \Delta_{w_P} g(t; \lambda,k)
\end{aligned} (\#eq:weibullpartexp)
\end{equation}

Where

\begin{equation}
g(t; \lambda, k) =  \gamma\left(1 + 1/k, \left({t\vee 0 \over \lambda}\right)^k\right) =  \frac{1}{k}\gamma\left(1/k, \left({t\vee 0 \over \lambda}\right)^k\right) - \frac{t}{\lambda}\exp\left(-\left({t\vee 0 \over \lambda}\right)^k\right)
\end{equation}
is a reparametrisation of the lower incomplete gamma function. Note that the $\vee$ operator $t \vee 0 = \text{max}(0, t)$ comes into the expression due to $\mathbb{1}(y \geq 0)$ term in the integrand.

\subsection{Survival function of $S_{+}$ for Weibull distribution}

By substituting equation \@ref(eq:weibullpartexp) into equation \@ref(eq:disccensunifprim) we can solve for the survival function of $S_+$ in terms of analytically available functions:

\begin{equation}
Q_{S+}(t ;\lambda,k) = Q_T(t + w_P; \lambda,k) + { 1 \over w_P} \Big[ \lambda \Delta_{w_P} g(t; \lambda,k) - t\Delta_{w_P}F_T(t; \lambda,k)\Big].
\end{equation}

\subsection{Weibull discrete censored delay distribution}

By substituting \@ref(eq:weibullpartexp) into \@ref(eq:disccensunifprim) we get the discrete censored delay distribution in terms of analytically available functions:

\begin{equation}
\begin{aligned}
f_n &= (n+1)F_T(n+1)  + (n-1)F_T(n-1) - 2nF_T(n) - \Delta_1\Big[ \int_{n-1}^n f_T(z) z ~dz \Big] \\
&= (n+1)F_T(n+1)  + (n-1)F_T(n-1) - 2nF_T(n) - \lambda \Delta_1^{(2)} g(n-1; \lambda,k) \\
&= (n+1)F_T(n+1)  + (n-1)F_T(n-1) - 2nF_T(n) \\
&+ \lambda [2 g(n; \lambda,k) - g(n+1; \lambda,k) - g(n-1; \lambda,k)] \qquad n = 0, 1, \dots.
\end{aligned}
\end{equation}

Which was also found by Cori \textit{et al} \cite{Cori2013}.


\end{document}

